# Build

Simply build the complete project with make:

```shell
make
```

To rebuild some internal parts during development, run other makefiles as described below.

The main makefile works on both Windows and Linux.
On Linux, it uses shell to execute commands while on Windows it uses CMD.
Other makefiles (`gen.mk` and `dep.mk`) might not work on Windows currently.

## Structure

The build process is separated into three parts:
1. Lexer & parser generation.
2. Dependency generation.
3. Compilation and linkage.

The first two parts are only performed during development:
the first one when the lexer or parser definitions are changed
and the second one when some `#include`s are changed.
The generated files are kept in the git repository,
so to compile a complete project, only the third part must be performed.

There is a separate makefile for each of these parts:
1. `gen.mk`
2. `dep.mk`
3. `makefile`

To run a specific makefile, use the `-f` option:

```shell
make -f gen.mk
make -f dep.mk
```

There are also other makefiles that are not meant to be executed directly:
* `config.mk` - Modifiable configuration of the build process.
* `steup.mk` - Internal configuration.
* `dep/src/*.mk` and `dep/entry/*.mk` - Generated dependencies.

## Config

`config.mk` can be modified to alter project structure, set C++ standard
or chose a prefered compiler, linker, dependency generator and shell with additional options.
Don't modify any other files. C++20 is currently required for this project.
Some C++20 features are still not supported even by latest compilers.
I've tested and confirmed the language and standard library features support on GCC 10, Clang 10 and Clang 11.
I do prefer Clang because of its error messages, but GCC works just as well
and is also needed for dependency generation.

## Individual targets

`gen.mk` generates two header files in `inc/` and one implementation file in `src/`.
These files are generated with `bison` and `lex`. Additionally, the parser generated by `bison`
is manally tweaked to remove any default-construction of the AST nodes.
*This is probably not a good idea, since a different version of `bison` could generate
files with different structure, but for now it's a simpler solution than
allowing default constructed AST nodes in invalid state.*

*There might be some warnings during compilation of the generated files.
This is because `flex` or `bison` might generate some unused code.
I'll probably add options to suppress these warnings but for now I want to keep them.*

`dep.mk` generates files in `dep/src/` and `dep/entry/`.
The generated files describe dependecies of object files on headers
and additionally of depencency makefiles on the same headers to force
regeneration of these dependencies when the header dependencies change.

`makefile` compiles implementation files from `src/` into object files in `bin/`
and also links these object files into final executable files in `dist/` for every entry file in `entry/`.
Both actions are performed by default but are also separated into phony targets `compile` and `link`.

Each one of the makefiles contains a phony `clean` target for cleanup of the respective parts.
For `makefile`, the cleanup is also separated into targets `clean-bin` and `clean-dist`.

## Pretty output

I personally prefer to run the makefiles like this:

```shell
clear; make |& batcat
clear; make -f dep.mk |& batcat
clear; make -f gen.mk |& batcat
```

*`batcat` is just a nicer-looking `less` with colored highlighting.
`config.mk` contains some compiler options to keep the colors in `batcat`
but I haven't managed to make the output look good with `less`.*
